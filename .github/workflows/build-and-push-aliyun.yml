name: Build and Push to Aliyun ACR

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      server:
        description: "Build SSH Terminal Server"
        required: false
        default: true
        type: boolean
      web:
        description: "Build SSH Terminal Web"
        required: false
        default: true
        type: boolean
      docs:
        description: "Build SSH Terminal Docs"
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  NAMESPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
  ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
  ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

jobs:
  # ================= SSH Terminal Server =================
  build-server:
    if: github.event_name == 'push' || inputs.server == true
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¹ é‡Šæ”¾ç£ç›˜ç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 256
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker'

      - name: Restart docker
        run: sudo service docker restart

      # ğŸ“¥ æ‹‰å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ§  å¤šæ¶æ„æ”¯æŒ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ” ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: Login to Aliyun ACR
        run: |
          set -euo pipefail
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login \
            --username "$ALIYUN_REGISTRY_USER" \
            --password-stdin "$REGISTRY"

      # ğŸ·ï¸ å‡†å¤‡é•œåƒä¿¡æ¯
      - name: Prepare image tags
        id: prep-server
        run: |
          set -euo pipefail
          IMAGE=${REGISTRY}/${NAMESPACE}/ssh-terminal-server
          VERSION=${GITHUB_REF_NAME}
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Image: $IMAGE"
          echo "Version: $VERSION"

      # ğŸš€ æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
      - name: Build and Push Server
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ steps.prep-server.outputs.image }}:${{ steps.prep-server.outputs.version }} \
            -t ${{ steps.prep-server.outputs.image }}:latest \
            --push \
            ./ssh-terminal-server

  # ================= SSH Terminal Web =================
  build-web:
    if: github.event_name == 'push' || inputs.web == true
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¹ é‡Šæ”¾ç£ç›˜ç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 256
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker'

      - name: Restart docker
        run: sudo service docker restart

      # ğŸ“¥ æ‹‰å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ§  å¤šæ¶æ„æ”¯æŒ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ” ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: Login to Aliyun ACR
        run: |
          set -euo pipefail
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login \
            --username "$ALIYUN_REGISTRY_USER" \
            --password-stdin "$REGISTRY"

      # ğŸ·ï¸ å‡†å¤‡é•œåƒä¿¡æ¯
      - name: Prepare image tags
        id: prep-web
        run: |
          set -euo pipefail
          IMAGE=${REGISTRY}/${NAMESPACE}/ssh-terminal-web
          VERSION=${GITHUB_REF_NAME}
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Image: $IMAGE"
          echo "Version: $VERSION"

      # ğŸš€ æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
      - name: Build and Push Web
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ steps.prep-web.outputs.image }}:${{ steps.prep-web.outputs.version }} \
            -t ${{ steps.prep-web.outputs.image }}:latest \
            --push \
            ./ssh-terminal-web

  # ================= SSH Terminal Docs =================
  build-docs:
    if: github.event_name == 'push' || inputs.docs == true
    runs-on: ubuntu-latest

    steps:
      # ğŸ§¹ é‡Šæ”¾ç£ç›˜ç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 256
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker'

      - name: Restart docker
        run: sudo service docker restart

      # ğŸ“¥ æ‹‰å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ§  å¤šæ¶æ„æ”¯æŒ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ” ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: Login to Aliyun ACR
        run: |
          set -euo pipefail
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login \
            --username "$ALIYUN_REGISTRY_USER" \
            --password-stdin "$REGISTRY"

      # ğŸ·ï¸ å‡†å¤‡é•œåƒä¿¡æ¯
      - name: Prepare image tags
        id: prep-docs
        run: |
          set -euo pipefail
          IMAGE=${REGISTRY}/${NAMESPACE}/ssh-terminal-docs
          VERSION=${GITHUB_REF_NAME}
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Image: $IMAGE"
          echo "Version: $VERSION"

      # ğŸš€ æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
      - name: Build and Push Docs
        run: |
          set -euo pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ steps.prep-docs.outputs.image }}:${{ steps.prep-docs.outputs.version }} \
            -t ${{ steps.prep-docs.outputs.image }}:latest \
            --push \
            ./ssh-terminal-docs

  # ================= æ¨é€å®Œæˆé€šçŸ¥ =================
  notify:
    name: Build Complete
    if: always()
    needs: [build-server, build-web, build-docs]
    runs-on: ubuntu-latest

    steps:
      - name: Check results
        run: |
          echo "Server: ${{ needs.build-server.result }}"
          echo "Web: ${{ needs.build-web.result }}"
          echo "Docs: ${{ needs.build-docs.result }}"