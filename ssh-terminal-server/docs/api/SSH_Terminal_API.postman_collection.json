{
    "info": {
        "_postman_id": "ssh-terminal-sync-api",
        "name": "SSH Terminal Sync API",
        "description": "SSH Terminal 云端同步 API 完整测试集合",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "variable": [
        {
            "key": "base_url",
            "value": "http://localhost:3000",
            "type": "string",
            "description": "API 基础 URL"
        },
        {
            "key": "access_token",
            "value": "",
            "type": "string",
            "description": "JWT 访问令牌（登录后自动设置）"
        },
        {
            "key": "refresh_token",
            "value": "",
            "type": "string",
            "description": "JWT 刷新令牌（登录后自动设置）"
        },
        {
            "key": "session_id",
            "value": "",
            "type": "string",
            "description": "SSH 会话 ID（创建后自动设置）"
        },
        {
            "key": "user_id",
            "value": "",
            "type": "string",
            "description": "用户 ID（从响应中获取）"
        }
    ],
    "item": [
        {
            "name": "1. Authentication",
            "item": [
                {
                    "name": "1.1 Register",
                    "event": [
                        {
                            "listen": "prerequest",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "// 清空 token（注册时不需要认证）",
                                    "pm.environment.set(\"access_token\", \"\");",
                                    "pm.environment.set(\"refresh_token\", \"\");"
                                ]
                            }
                        },
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200 or 409 (user exists)\", function () {",
                                    "    pm.expect(pm.response.code).to.be.oneOf([200, 409]);",
                                    "});",
                                    "",
                                    "if (pm.response.code === 200) {",
                                    "  const jsonData = pm.response.json();",
                                    "  pm.environment.set(\"access_token\", jsonData.data.access_token);",
                                    "  pm.environment.set(\"refresh_token\", jsonData.data.refresh_token);",
                                    "  pm.environment.set(\"user_id\", jsonData.data.user.id);",
                                    "  console.log(\"✅ 注册成功，token 已保存\");",
                                    "} else {",
                                    "  console.log(\"⚠️  用户已存在，请直接登录\");",
                                    "}"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"Password123!\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/register",
                            "host": ["{{base_url}}"],
                            "path": ["auth", "register"]
                        },
                        "description": "注册新用户"
                    }
                },
                {
                    "name": "1.2 Login",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "const jsonData = pm.response.json();",
                                    "pm.environment.set(\"access_token\", jsonData.data.access_token);",
                                    "pm.environment.set(\"refresh_token\", jsonData.data.refresh_token);",
                                    "console.log(\"✅ 登录成功，token 已保存\");",
                                    "console.log(\"Access Token:\", jsonData.data.access_token.substring(0, 20) + \"...\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"Password123!\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/login",
                            "host": ["{{base_url}}"],
                            "path": ["auth", "login"]
                        },
                        "description": "用户登录"
                    }
                },
                {
                    "name": "1.3 Refresh Token",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "const jsonData = pm.response.json();",
                                    "pm.environment.set(\"access_token\", jsonData.data.access_token);",
                                    "if (jsonData.data.refresh_token) {",
                                    "  pm.environment.set(\"refresh_token\", jsonData.data.refresh_token);",
                                    "}",
                                    "console.log(\"✅ Token 刷新成功\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"refresh_token\": \"{{refresh_token}}\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/auth/refresh",
                            "host": ["{{base_url}}"],
                            "path": ["auth", "refresh"]
                        },
                        "description": "刷新访问令牌"
                    }
                }
            ]
        },
        {
            "name": "2. User Profile",
            "item": [
                {
                    "name": "2.1 Get Profile",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "console.log(\"✅ 获取用户资料成功\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/user/profile",
                            "host": ["{{base_url}}"],
                            "path": ["api", "user", "profile"]
                        },
                        "description": "获取当前用户资料"
                    }
                },
                {
                    "name": "2.2 Update Profile",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ 用户资料更新成功，server_ver:\", jsonData.data.server_ver);"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "PUT",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"username\": \"张三\",\n  \"phone\": \"13800138000\",\n  \"qq\": \"123456789\",\n  \"wechat\": \"wx123456\",\n  \"bio\": \"全栈开发工程师\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/user/profile",
                            "host": ["{{base_url}}"],
                            "path": ["api", "user", "profile"]
                        },
                        "description": "创建或更新用户资料"
                    }
                },
                {
                    "name": "2.3 Delete Profile",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "console.log(\"✅ 用户资料已删除（软删除）\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "DELETE",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/user/profile",
                            "host": ["{{base_url}}"],
                            "path": ["api", "user", "profile"]
                        },
                        "description": "删除用户资料（软删除）"
                    }
                }
            ]
        },
        {
            "name": "3. SSH Sessions",
            "item": [
                {
                    "name": "3.1 Get All Sessions",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ 获取到\", jsonData.data.data.length, \"个 SSH 会话\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/ssh/sessions?page=1&page_size=20",
                            "host": ["{{base_url}}"],
                            "path": ["api", "ssh", "sessions"]
                        },
                        "description": "获取所有 SSH 会话（分页）"
                    }
                },
                {
                    "name": "3.2 Create Session",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "pm.environment.set(\"session_id\", jsonData.data.id);",
                                    "console.log(\"✅ SSH 会话创建成功，ID:\", jsonData.data.id);"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"name\": \"生产服务器\",\n  \"host\": \"192.168.1.100\",\n  \"port\": 22,\n  \"username\": \"root\",\n  \"group_name\": \"生产环境\",\n  \"terminal_type\": \"xterm\",\n  \"columns\": 80,\n  \"rows\": 24,\n  \"auth_method_encrypted\": \"encrypted_password_here\",\n  \"auth_nonce\": \"random_nonce_16bytes\",\n  \"auth_key_salt\": \"random_salt_32bytes\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/ssh/sessions",
                            "host": ["{{base_url}}"],
                            "path": ["api", "ssh", "sessions"]
                        },
                        "description": "创建新的 SSH 会话"
                    }
                },
                {
                    "name": "3.3 Get Session",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "console.log(\"✅ 获取 SSH 会话成功\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/ssh/sessions/{{session_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "ssh", "sessions", "{{session_id}}"]
                        },
                        "description": "获取单个 SSH 会话详情"
                    }
                },
                {
                    "name": "3.4 Update Session",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ SSH 会话更新成功，server_ver:\", jsonData.data.server_ver);"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "PUT",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"name\": \"生产服务器（已更新）\",\n  \"group_name\": \"生产环境\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/ssh/sessions/{{session_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "ssh", "sessions", "{{session_id}}"]
                        },
                        "description": "更新 SSH 会话（部分更新）"
                    }
                },
                {
                    "name": "3.5 Delete Session",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "console.log(\"✅ SSH 会话已删除（软删除）\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "DELETE",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/ssh/sessions/{{session_id}}",
                            "host": ["{{base_url}}"],
                            "path": ["api", "ssh", "sessions", "{{session_id}}"]
                        },
                        "description": "删除 SSH 会话（软删除）"
                    }
                }
            ]
        },
        {
            "name": "4. Sync",
            "item": [
                {
                    "name": "4.1 Pull",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ Pull 成功\");",
                                    "console.log(\"- 服务器时间:\", new Date(jsonData.data.server_time));",
                                    "console.log(\"- SSH 会话数:\", jsonData.data.ssh_sessions.length);",
                                    "console.log(\"- 冲突数:\", jsonData.data.conflicts.length);"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"last_sync_at\": null,\n  \"device_id\": \"postman-test-device\",\n  \"entity_types\": [\"user_profiles\", \"ssh_sessions\"]\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/sync/pull",
                            "host": ["{{base_url}}"],
                            "path": ["api", "sync", "pull"]
                        },
                        "description": "拉取服务器数据"
                    }
                },
                {
                    "name": "4.2 Push",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ Push 成功\");",
                                    "console.log(\"- 更新会话数:\", jsonData.data.updated_session_ids.length);",
                                    "console.log(\"- 冲突数:\", jsonData.data.conflicts.length);",
                                    "",
                                    "if (jsonData.data.conflicts.length > 0) {",
                                    "  console.log(\"⚠️  检测到冲突，需要解决！\");",
                                    "  jsonData.data.conflicts.forEach((conflict, index) => {",
                                    "    console.log((index + 1) + \". 冲突:\", conflict.id);",
                                    "    console.log(\"   客户端版本:\", conflict.client_ver);",
                                    "    console.log(\"   服务器版本:\", conflict.server_ver);",
                                    "  });",
                                    "}"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"device_id\": \"postman-test-device\",\n  \"user_profile\": {\n    \"bio\": \"通过 Postman 更新的简介\"\n  },\n  \"ssh_sessions\": [\n    {\n      \"id\": \"{{session_id}}\",\n      \"name\": \"通过 Postman 更新的会话\",\n      \"host\": \"192.168.1.100\",\n      \"port\": 22,\n      \"username\": \"root\",\n      \"group_name\": \"测试环境\",\n      \"terminal_type\": \"xterm\",\n      \"columns\": 80,\n      \"rows\": 24,\n      \"auth_method_encrypted\": \"encrypted_data\",\n      \"auth_nonce\": \"nonce\",\n      \"auth_key_salt\": \"salt\",\n      \"client_ver\": 1\n    }\n  ],\n  \"deleted_session_ids\": []\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/sync/push",
                            "host": ["{{base_url}}"],
                            "path": ["api", "sync", "push"]
                        },
                        "description": "推送本地更改到服务器"
                    }
                },
                {
                    "name": "4.3 Resolve Conflict - Keep Server",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ 冲突已解决（保留服务器版本）\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"conflict_id\": \"{{session_id}}\",\n  \"strategy\": \"KeepServer\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/sync/resolve-conflict",
                            "host": ["{{base_url}}"],
                            "path": ["api", "sync", "resolve-conflict"]
                        },
                        "description": "解决冲突 - 保留服务器版本"
                    }
                },
                {
                    "name": "4.4 Resolve Conflict - Keep Local",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ 冲突已解决（保留本地版本）\");"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"conflict_id\": \"{{session_id}}\",\n  \"strategy\": \"KeepLocal\",\n  \"client_data\": {\n    \"id\": \"{{session_id}}\",\n    \"name\": \"本地版本会话\",\n    \"host\": \"192.168.1.100\",\n    \"port\": 22,\n    \"username\": \"root\"\n  }\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/sync/resolve-conflict",
                            "host": ["{{base_url}}"],
                            "path": ["api", "sync", "resolve-conflict"]
                        },
                        "description": "解决冲突 - 保留本地版本"
                    }
                },
                {
                    "name": "4.5 Resolve Conflict - Keep Both",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "type": "text/javascript",
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "  pm.response.to.have.status(200);",
                                    "});",
                                    "const jsonData = pm.response.json();",
                                    "console.log(\"✅ 冲突已解决（保留两个版本）\");",
                                    "console.log(\"新会话 ID:\", jsonData.data.new_id);"
                                ]
                            }
                        }
                    ],
                    "request": {
                        "auth": {
                            "type": "bearer",
                            "bearer": [
                                {
                                    "key": "token",
                                    "value": "{{access_token}}",
                                    "type": "string"
                                }
                            ]
                        },
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"conflict_id\": \"{{session_id}}\",\n  \"strategy\": \"KeepBoth\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/sync/resolve-conflict",
                            "host": ["{{base_url}}"],
                            "path": ["api", "sync", "resolve-conflict"]
                        },
                        "description": "解决冲突 - 创建副本保留两个版本"
                    }
                }
            ]
        }
    ]
}
